#!/bin/bash

get_image() {
    if [ -z "$1" ]; then
        echo "Empty list of options" >&2
        exit 1
    fi

    while getopts ":i:" option; do
        case $option in
        i)
            image=$OPTARG
            ;;
        \?)
            echo "Invalid option: -${OPTARG}" >&2
            exit 1
            ;;
        esac
    done
}

set_wallpaper() {
    local index_plist="$HOME/Library/Application Support/com.apple.wallpaper/Store/Index.plist"
    local tmp_config_plist="/tmp/wallpaper_config.plist"
    local tmp_encoded="/tmp/wallpaper_config_encoded.b64"

    plutil -extract "AllSpacesAndDisplays.Desktop.Content.Choices.0.Configuration" raw "$index_plist" \
        | base64 --decode > "$tmp_config_plist"

    /usr/libexec/PlistBuddy -c "Set :url:relative file:///$image" "$tmp_config_plist" 2>/dev/null \
        || /usr/libexec/PlistBuddy -c "Add :url:relative string file:///$image" "$tmp_config_plist"

    base64 < "$tmp_config_plist" > "$tmp_encoded"
    plutil -replace "AllSpacesAndDisplays.Desktop.Content.Choices.0.Configuration" -data "$(cat "$tmp_encoded")" "$index_plist"

    pkill -f WallpaperAgent &
}

generate_colorscheme() {
    cp "$image" /tmp/wallpaper.jpg

    wal -i "$image" --cols16 lighten
}

reload_apps() {
    sketchybar --reload &
    walogram -i "$image" &
    osascript ~/.config/ghostty/reload.scpt &
}

set_fastfetch() {
    magick -size 800x1000 xc:none -draw "roundrectangle 0,0,800,1000,100,100" /tmp/mask.png
    magick /tmp/wallpaper.jpg -gravity Center -extent 8:10 -resize 800x1000 -alpha set /tmp/mask.png \
        -compose DstIn -composite "$HOME/.config/fastfetch/logo.png"
    rm /tmp/mask.png
}

main() {
    image=""

    get_image "$@"
    set_wallpaper
    generate_colorscheme
    set_fastfetch

    reload_apps &

    wait
}

main "$@"
