#!/bin/bash

get_image() {
  if [ -z "$1" ]; then
    echo "Empty list of options" >&2
    exit 1
  fi

  while getopts ":i:" option; do
    case $option in
      i)
        image=$OPTARG
        ;;
      \?)
        echo "Invalid option: -${OPTARG}" >&2
        exit 1
        ;;
    esac
  done
}

set_wallpaper() {
  /usr/libexec/PlistBuddy -c "set AllSpacesAndDisplays:Desktop:Content:Choices:0:Files:0:relative file:///$image" ~/Library/Application\ Support/com.apple.wallpaper/Store/Index.plist
  pkill -f WallpaperAgent &
}

generate_colorscheme() {
    cp "$image" /tmp/wallpaper.jpg

    wal -n -s --theme "$HOME/.config/wal/colorschemes/dark/lackluster.json"
}

reload_apps() {
  walogram -i "$image" &
}

set_fastfetch() {
    magick -size 800x1000 xc:none -draw "roundrectangle 0,0,800,1000,100,100" /tmp/mask.png
    magick /tmp/wallpaper.jpg -gravity Center -extent 8:10 -resize 800x1000 -alpha set /tmp/mask.png \
        -compose DstIn -composite "$HOME/.config/fastfetch/logo.png"
    rm /tmp/mask.png
}

main() {
    image=""

    get_image "$@"
    set_wallpaper
    generate_colorscheme
    reload_apps
    set_fastfetch

    wait
}

main "$@"
